#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
export SWIFT_MODULECACHE_PATH="${SWIFT_MODULECACHE_PATH:-/tmp/afm-api-swift-module-cache}"
mkdir -p "$SWIFT_MODULECACHE_PATH"

RUNTIME_DIR="${AFM_API_RUNTIME_DIR:-/tmp/afm-api}"
PID_FILE="$RUNTIME_DIR/afm-api.pid"
LOG_FILE="$RUNTIME_DIR/afm-api.log"
mkdir -p "$RUNTIME_DIR"
export AFM_API_LOG_FILE="$LOG_FILE"

DEFAULT_HOST="${AFM_API_HOST:-127.0.0.1}"
DEFAULT_PORT="${AFM_API_PORT:-8000}"
DEFAULT_API_VERSION="${AFM_API_VERSION:-latest}"
DEFAULT_SOURCE_ROOT="${AFM_API_SOURCE_ROOT:-}"

resolve_source_root() {
  if [[ -n "$DEFAULT_SOURCE_ROOT" && -f "$DEFAULT_SOURCE_ROOT/Package.swift" ]]; then
    echo "$DEFAULT_SOURCE_ROOT"
    return
  fi

  if [[ -f "$SCRIPT_DIR/../Package.swift" ]]; then
    echo "$SCRIPT_DIR/.."
    return
  fi

  if [[ -f "$SCRIPT_DIR/../share/afm-api/Package.swift" ]]; then
    echo "$SCRIPT_DIR/../share/afm-api"
    return
  fi

  echo ""
}

SOURCE_ROOT="$(resolve_source_root)"
if [[ -z "$SOURCE_ROOT" ]]; then
  echo "Could not locate Package.swift for afm-api. Set AFM_API_SOURCE_ROOT."
  exit 1
fi

BUILD_DIR="${AFM_API_BUILD_DIR:-$RUNTIME_DIR/build}"
SERVER_BIN="$BUILD_DIR/release/afm-api-server"

is_running() {
  if [[ ! -f "$PID_FILE" ]]; then
    return 1
  fi
  local pid
  pid="$(cat "$PID_FILE" 2>/dev/null || true)"
  if [[ -z "$pid" ]]; then
    return 1
  fi
  if kill -0 "$pid" 2>/dev/null; then
    return 0
  fi
  return 1
}

has_arg() {
  local needle="$1"
  shift
  local arg
  for arg in "$@"; do
    if [[ "$arg" == "$needle" ]]; then
      return 0
    fi
  done
  return 1
}

background=false
stop=false
status=false
logs=false
follow=false
rebuild=false
passthrough=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    --background|-d)
      background=true
      ;;
    --stop|-stop)
      stop=true
      ;;
    --status|-status)
      status=true
      ;;
    --logs|-logs)
      logs=true
      ;;
    --follow|-f)
      follow=true
      ;;
    --rebuild)
      rebuild=true
      ;;
    *)
      passthrough+=("$1")
      ;;
  esac
  shift
done

if [[ "$stop" == true ]]; then
  if is_running; then
    pid="$(cat "$PID_FILE")"
    kill "$pid" 2>/dev/null || true
    for _ in {1..20}; do
      if kill -0 "$pid" 2>/dev/null; then
        sleep 0.1
      else
        break
      fi
    done
    rm -f "$PID_FILE"
    echo "Stopped afm-api (pid $pid)"
  else
    rm -f "$PID_FILE"
    echo "afm-api is not running"
  fi
  exit 0
fi

if [[ "$status" == true ]]; then
  if is_running; then
    echo "afm-api is running (pid $(cat "$PID_FILE"))"
  else
    echo "afm-api is not running"
  fi
  exit 0
fi

if [[ "$logs" == true ]]; then
  if [[ ! -f "$LOG_FILE" ]]; then
    echo "No log file found at $LOG_FILE"
    exit 1
  fi
  if [[ "$follow" == true ]]; then
    tail -f "$LOG_FILE"
  else
    tail -n 200 "$LOG_FILE"
  fi
  exit 0
fi

if ! has_arg "--host" "${passthrough[@]-}"; then
  passthrough+=("--host" "$DEFAULT_HOST")
fi
if ! has_arg "--port" "${passthrough[@]-}"; then
  passthrough+=("--port" "$DEFAULT_PORT")
fi
if ! has_arg "--api-version" "${passthrough[@]-}"; then
  passthrough+=("--api-version" "$DEFAULT_API_VERSION")
fi

build_server() {
  swift build \
    --package-path "$SOURCE_ROOT" \
    --scratch-path "$BUILD_DIR" \
    -c release \
    --product afm-api-server
}

if [[ "$rebuild" == true ]]; then
  rm -rf "$BUILD_DIR"
fi

if [[ ! -x "$SERVER_BIN" ]]; then
  build_server
fi

cmd=("$SERVER_BIN")

if [[ "$background" == true ]]; then
  if is_running; then
    echo "afm-api already running (pid $(cat "$PID_FILE"))"
    echo "Logs: $LOG_FILE"
    exit 0
  fi
  nohup "${cmd[@]}" "${passthrough[@]}" >>"$LOG_FILE" 2>&1 &
  pid=$!
  echo "$pid" > "$PID_FILE"
  sleep 0.2
  if kill -0 "$pid" 2>/dev/null; then
    echo "afm-api started in background (pid $pid)"
    echo "Logs: $LOG_FILE"
  else
    echo "afm-api failed to start. Logs:"
    tail -n 80 "$LOG_FILE" || true
    rm -f "$PID_FILE"
    exit 1
  fi
  exit 0
fi

exec "${cmd[@]}" "${passthrough[@]}"
