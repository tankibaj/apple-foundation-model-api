#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
export SWIFT_MODULECACHE_PATH="${SWIFT_MODULECACHE_PATH:-/tmp/afm-api-swift-module-cache}"
mkdir -p "$SWIFT_MODULECACHE_PATH"

RUNTIME_DIR="${AFM_API_RUNTIME_DIR:-/tmp/afm-api}"
PID_FILE="$RUNTIME_DIR/afm-api.pid"
LOG_FILE="$RUNTIME_DIR/afm-api.log"
mkdir -p "$RUNTIME_DIR"

DEFAULT_HOST="${AFM_API_HOST:-127.0.0.1}"
DEFAULT_PORT="${AFM_API_PORT:-8000}"
DEFAULT_API_VERSION="${AFM_API_VERSION:-latest}"

is_running() {
  if [[ ! -f "$PID_FILE" ]]; then
    return 1
  fi
  local pid
  pid="$(cat "$PID_FILE" 2>/dev/null || true)"
  if [[ -z "$pid" ]]; then
    return 1
  fi
  if kill -0 "$pid" 2>/dev/null; then
    return 0
  fi
  return 1
}

has_arg() {
  local needle="$1"
  shift
  local arg
  for arg in "$@"; do
    if [[ "$arg" == "$needle" ]]; then
      return 0
    fi
  done
  return 1
}

background=false
stop=false
status=false
logs=false
follow=false
passthrough=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    --background|-d)
      background=true
      ;;
    --stop)
      stop=true
      ;;
    --status)
      status=true
      ;;
    --logs)
      logs=true
      ;;
    --follow|-f)
      follow=true
      ;;
    *)
      passthrough+=("$1")
      ;;
  esac
  shift
done

if [[ "$stop" == true ]]; then
  if is_running; then
    pid="$(cat "$PID_FILE")"
    kill "$pid" 2>/dev/null || true
    for _ in {1..20}; do
      if kill -0 "$pid" 2>/dev/null; then
        sleep 0.1
      else
        break
      fi
    done
    rm -f "$PID_FILE"
    echo "Stopped afm-api (pid $pid)"
  else
    rm -f "$PID_FILE"
    echo "afm-api is not running"
  fi
  exit 0
fi

if [[ "$status" == true ]]; then
  if is_running; then
    echo "afm-api is running (pid $(cat "$PID_FILE"))"
  else
    echo "afm-api is not running"
  fi
  exit 0
fi

if [[ "$logs" == true ]]; then
  if [[ ! -f "$LOG_FILE" ]]; then
    echo "No log file found at $LOG_FILE"
    exit 1
  fi
  if [[ "$follow" == true ]]; then
    tail -f "$LOG_FILE"
  else
    tail -n 200 "$LOG_FILE"
  fi
  exit 0
fi

if ! has_arg "--host" "${passthrough[@]-}"; then
  passthrough+=("--host" "$DEFAULT_HOST")
fi
if ! has_arg "--port" "${passthrough[@]-}"; then
  passthrough+=("--port" "$DEFAULT_PORT")
fi
if ! has_arg "--api-version" "${passthrough[@]-}"; then
  passthrough+=("--api-version" "$DEFAULT_API_VERSION")
fi

cmd=(swift -module-cache-path "$SWIFT_MODULECACHE_PATH" "$SCRIPT_DIR/../src/afm-api.swift")

if [[ "$background" == true ]]; then
  if is_running; then
    echo "afm-api already running (pid $(cat "$PID_FILE"))"
    echo "Logs: $LOG_FILE"
    exit 0
  fi
  nohup "${cmd[@]}" "${passthrough[@]}" >>"$LOG_FILE" 2>&1 &
  pid=$!
  echo "$pid" > "$PID_FILE"
  sleep 0.2
  if kill -0 "$pid" 2>/dev/null; then
    echo "afm-api started in background (pid $pid)"
    echo "Logs: $LOG_FILE"
  else
    echo "afm-api failed to start. Logs:"
    tail -n 80 "$LOG_FILE" || true
    rm -f "$PID_FILE"
    exit 1
  fi
  exit 0
fi

exec "${cmd[@]}" "${passthrough[@]}"
